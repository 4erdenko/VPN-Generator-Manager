version: '3.9'

services:
    wireguard:
      image: linuxserver/wireguard
      container_name: wireguard
      restart: unless-stopped
      volumes:
        - './wireguard:/config'
        - '/lib/modules:/lib/modules:ro'
      environment:
        - PUID=1000
        - PGID=1000
      cap_add:
        - NET_ADMIN
        - SYS_MODULE
      privileged: true
      sysctls:
        - net.ipv4.conf.all.src_valid_mark=1
        - net.ipv6.conf.all.disable_ipv6=0
      networks:
        - backbone

    telegram_bot:
      build: .
      container_name: bednorz_bot
      command: ["python", "main.py"]
      restart: unless-stopped
      network_mode: service:wireguard
      depends_on:
        - wireguard



    fastapi:
      build: fastapi_app
      command: bash -c "alembic revision --autogenerate -m 'Auto generated migration' && alembic upgrade head && uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
      restart: unless-stopped
      ports:
        - "8000:8000"
      depends_on:
        - db
      environment:
        - DATABASE_URL=postgresql://username:password@db:5432/database


    db:
      image: postgres:13
      restart: unless-stopped
      ports:
        - "5432:5432"
      environment:
        - POSTGRES_USER=username
        - POSTGRES_PASSWORD=password
        - POSTGRES_DB=database

networks:
  backbone:
    driver: bridge
